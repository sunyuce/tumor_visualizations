<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>患者详情</title>
    <link rel="icon" href="../static/background.png" type="image/png">
    <link rel="stylesheet" href="../static/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../static/bootstrap.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        body {
            background: linear-gradient(135deg, #343a40, #1c1f24);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: #ffffff;
            font-family: Arial, sans-serif;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container1 {
            display: flex;
            width: 98%;
            height: 98%;
            margin: 0.5%;
            box-sizing: border-box;
            border: 2px solid #444; /* 深色外边框 */
            border-radius: 10px;
            padding: 5px;
            background-color: #2c2f33;
        }

        .left_part{
            flex: 3;
            height: auto;
            box-sizing: border-box;
            border-right: 2px solid #444; /* 左右部分之间的边框 */
            padding: 5px;
        }
        .right_part {
            flex: 1;
            height: auto;
            box-sizing: border-box;
            padding: 10px;
        }
        #three_container{
            display: flex;
            flex-flow: row;
            margin-bottom: 10px;
        }
        #tumor_3D {
            height: 540px;
            width: 540px;
            position: relative; /* 相对定位 */
            border: 2px solid #007bff; /* 边框颜色 */
            border-radius: 10px; /* 边框圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 盒阴影 */
            /*margin-bottom: 10px;*/
            /*margin: 10px auto; !* 上下边距 *!*/
        }
        #tumor_4D {
            height: 540px;
            width: 540px;
            position: relative; /* 相对定位 */
            border: 2px solid #007bff; /* 边框颜色 */
            border-radius: 10px; /* 边框圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 盒阴影 */
            /*margin-bottom: 10px;*/
            /*margin: 10px auto; !* 上下边距 *!*/
        }
        #tumor_three{
            display: flex;
            flex-flow: column;
        }
        #tumor_three img{
            /*flex: 1;*/
            width: 180px;
            height: 180px;
            border: 2px solid #007bff; /* 边框颜色 */
            border-radius: 5px; /* 边框圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 盒阴影 */
        }
        #mriSlides{
            width: 256px;
            height: 256px;
            border: 2px solid #007bff; /* 边框颜色 */
            border-radius: 5px; /* 边框圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 盒阴影 */
        }
        .controls {
            position: absolute; /* 绝对定位 */
            top: 3%;
            left: 1.8%;
            display: flex; /* 使用flex布局 */
            z-index: 10; /* 确保按钮浮在图像上方 */
        }
        .controls button {
            margin-right: 10px; /* 按钮之间的间距 */
        }
        #imageContainer1{
            padding-top: 20px;
            /*border-top: 2px solid #444; !* table-container和container_index之间的边框 *!*/
        }
        #images_show{
            display: flex;
            flex-flow: row;
            border-top: 2px solid #444;
        }
        .container2{
            margin-top: 25px;
            padding: 10px;
            border-bottom: 2px solid #444; /* table-container和container_index之间的边框 */
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            background-color: #495057;
            color: #ffffff;
        }
        .table thead {
            background-color: #212529;
        }
        .table tbody {
            color: #ffffff;
        }
        .table-hover tbody tr:hover {
            background-color: #6c757d;
            color: #800020;
        }
        #images_showleft{
            display: flex;
            flex-flow: column;
        }
        #images_showright{
            display: flex;
            flex-flow: column;
            /*margin: 10px;*/
            margin: auto 10px;
            padding-left: 15px;
            border-left: 2px solid #444;;

        }
        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            /*width: 768px;*/
            /*height: 256px;*/
            width: 960px;
            height: 160px;
            /*margin: 0 auto;*/
            overflow: hidden;
        }
        .image-container img {
            /*width: 256px;*/
            /*height: 256px;*/
            width: 160px;
            height: 160px;
            transition: opacity 0.5s ease-in-out;
            cursor: pointer;
            border: 2px solid #000000; /* 边框颜色 */
            border-radius: 10px; /* 边框圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 盒阴影 */
        }
        .image-buttons {
            position: absolute;
            left: 26.78%;
            bottom: 2%;
        }
        .image-buttons button {
            margin: 0 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: hidden; /* 禁止滚动 */
        }
        .modal-content {
            margin: 5% auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        .modal-content img {
            width: 100%;
            height: auto;
            display: block;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 25px;
            color: white;
            font-size: 35px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #999;
            text-decoration: none;
            cursor: pointer;
        }
        #back_to{
            position: absolute;
            right: 2%;
            top: 2%;
        }
        .container_index {
            display: flex;
            align-items: center;
            margin: 45px 20px 20px 20px;
        }
        #select{
            display: flex;
            align-items: center;
            margin: 10px;
        }

        label {
            /*margin-right: 10px;*/
            font-size: 16px;
            margin: 0px;
        }

        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 150px;
        }
        #Slideselect{
            position: relative;
            display: inline-block;
            width: 150px;
        }

        #dataSelect {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
        }

        #dataSelect option {
            background-color: #333;
            color: #fff;
        }

        #dataSelect:hover {
            border-color: #555;
        }

        #dataSelect:focus {
            outline: none;
            box-shadow: 0 0 5px 2px #555;
        }
        #selectSlides{
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
        }
        #selectSlides option {
            background-color: #333;
            color: #fff;
        }

        #selectSlides:hover {
            border-color: #555;
        }

        #selectSlides:focus {
            outline: none;
            box-shadow: 0 0 5px 2px #555;
        }

        .select-wrapper::after {
            content: '▼';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #fff;
        }
        #Slideselect::after{
            content: '▼';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container1">
        <div class="left_part">
            <div class="controls">
                <button id="resetButton" class="b1">
                    <i class="fa-solid fa-rotate fa-2x"></i>
                </button>
                <button id="rotateLeft" class="b1">
                    <i class="fa-solid fa-left fa-2x"></i>
                </button>
                <button id="rotateRight" class="b1">
                    <i class="fa-solid fa-right fa-2x"></i>
                </button>
                <button id="rotateUp" class="b1">
                    <img src="../static/graph_icons/rotateX-fill.png" alt="无" style="width: 2em;height: 2em">
                </button>
                <button id="rotateDown" class="b1">
                    <img src="../static/graph_icons/rotateX-fill.png" alt="无" style="width: 2em;height: 2em;transform:scaleY(-1);">
                </button>
            </div>
            <div id="three_container">
                <div id="tumor_3D"></div>
                <div id="tumor_4D"></div>
                <div id="tumor_three">
                    <img src="" alt="无" id="tumor_three_1">
                    <img src="" alt="无" id="tumor_three_2">
                    <img src="" alt="无" id="tumor_three_3">
                </div>
            </div>
<!--            <div id="tumor_3D"></div>-->
            <div id="images_show">
                <div id="images_showleft">
                    <div class="image-container" id="imageContainer1"></div>
                    <div class="image-container" id="imageContainer2"></div>
                    <div class="image-buttons">
                        <button id="prevButton" disabled>
                            <i class="fa-regular fa-arrow-left fa-2x"></i>
                        </button>
                        <button id="nextButton">
                            <i class="fa-regular fa-arrow-right fa-2x"></i>
                        </button>
                    </div>
                </div>
                <div id="images_showright">
                    <div id="select">
                        <label for="selectSlides">切面选择：</label>
                        <div id="Slideselect">
                            <select id="selectSlides">
                                <option id="axial" value="axial">水平面</option>
                                <option value="coronal" data-max="255">冠状面</option>
                                <option value="sagittal" data-max="255">矢状面</option>
                            </select>
                        </div>
                    </div>
                    <img id="mriSlides" src="" alt="MRI Image">
                    <input type="range" id="frameSlider" min="0" value="0">
                </div>
            </div>
        </div>
        <div class="right_part">
            <div class="container2">
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th style="white-space: nowrap">病人基本信息</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ID</td>
                                <td>{{ patient.id }}</td>
                            </tr>
                            <tr>
                                <td>病人编号</td>
                                <td>{{ patient.Patient }}</td>
                            </tr>
                            <tr>
                                <td>性别</td>
                                <td>{{ patient.gender }}</td>
                            </tr>
                            <tr>
                                <td>确诊年龄</td>
                                <td>{{ patient.age_at_initial_pathologic }}</td>
                            </tr>
                            <tr>
                                <td>生存状态</td>
                                <td>{{ patient.death01 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <a href="/?patient_number={{ request.args.get('patient_number', '') }}&gender={{ request.args.get('gender', '') }}&survival_status={{ request.args.get('survival_status', '') }}&page={{ request.args.get('page', 1) }}" class="btn btn-primary" id="back_to">返回</a>
            </div>
            <div class="container_index">
            <label for="dataSelect">性能指标：</label>
                <div class="select-wrapper">
                    <select id="dataSelect">
                        <option value="Val_loss">Val_loss</option>
                        <option value="mIoU">mIoU</option>
                        <option value="Dice">Dice</option>
                    </select>
                </div>
            </div>
              <div id="container_graph" style="height: 45%; width: 100%"></div>
            </div>
    </div>
    <div id="myModal" class="modal">
        <span class="close">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Modal Image">
        </div>
    </div>
    <!-- 载入vtk.js脚本 -->
    <script src='../static/vtk.js'></script>
    <script type="text/javascript" src="../static/js/echarts.min.js"></script>
    <script type="text/javascript" src="../static/js/line.js"></script>
    <!-- 载入展示三维重建的脚本 -->
    <script>
        // // 查找之前定义的用于可视化的div
        // var myContainer = document.querySelector('#tumor_3D');
        //
        // // 用于页面可视化的Renderer，官方文档介绍是使用fullScreenRenderer
        // var fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
        //     background: [0.0, 0.0, 0.0],
        //     container: myContainer,  // 绑定myContainer
        // });
        //
        // // 获取渲染器和渲染窗口
        // var renderer = fullScreenRenderer.getRenderer();
        // var renderWindow = fullScreenRenderer.getRenderWindow();
        //
        // // 定义actor和mapper
        // var actor = vtk.Rendering.Core.vtkActor.newInstance();
        // var mapper = vtk.Rendering.Core.vtkMapper.newInstance();
        //
        // // 定义vtpReader，读取.vtp文件
        // const vtpReader = vtk.IO.XML.vtkXMLPolyDataReader.newInstance();
        //
        // // 进行inputConnection连接
        // mapper.setInputConnection(vtpReader.getOutputPort());
        // actor.setMapper(mapper);
        //
        // // 调整模型的颜色
        // mapper.setScalarVisibility(true);
        // // actor.getProperty().setColor(1.0, 1.0, 1.0);
        //
        // // 获取模型的中心点
        // function getCenterOfMass() {
        //     const bounds = actor.getBounds();
        //     const center = [
        //         (bounds[0] + bounds[1]) / 2,
        //         (bounds[2] + bounds[3]) / 2,
        //         (bounds[4] + bounds[5]) / 2,
        //     ];
        //     return center;
        // }
        // // 保存初始相机状态
        // let initialCameraState;
        //
        // function saveInitialCameraState() {
        //     const camera = renderer.getActiveCamera();
        //     initialCameraState = {
        //         position: [...camera.getPosition()],
        //         focalPoint: [...camera.getFocalPoint()],
        //         viewUp: [...camera.getViewUp()],
        //         clippingRange: [...camera.getClippingRange()]
        //     };
        // }
        //
        // function resetCameraToInitialState() {
        //     const camera = renderer.getActiveCamera();
        //     camera.setPosition(...initialCameraState.position);
        //     camera.setFocalPoint(...initialCameraState.focalPoint);
        //     camera.setViewUp(...initialCameraState.viewUp);
        //     camera.setClippingRange(...initialCameraState.clippingRange);
        //     renderWindow.render();
        // }
        //
        // // 设置渲染函数
        // function beginRender() {
        //     renderer.addActor(actor);
        //     renderer.resetCamera();
        //     saveInitialCameraState();  // 保存初始相机状态
        //     renderWindow.render();
        // }
        //
        // // 获取患者的Patient值
        // var patientNumber = "{{ patient.Patient }}";
        // const tumorimage_1 = document.getElementById('tumor_three_1')
        // tumorimage_1.setAttribute('src','../static/heat_com/'+patientNumber+'/axial_com.png')
        // const tumorimage_2 = document.getElementById('tumor_three_2')
        // tumorimage_2.setAttribute('src','../static/heat_com/'+patientNumber+'/coronal_com.png')
        // const tumorimage_3 = document.getElementById('tumor_three_3')
        // tumorimage_3.setAttribute('src','../static/heat_com/'+patientNumber+'/sagittal_com.png')
        //
        // // 动态设置vtp文件的路径
        // var vtpUrl = "../static/combine/" + patientNumber + ".vtp";
        // // 寻找模型存放的位置并开始渲染
        // vtpReader.setUrl(vtpUrl).then(beginRender);
        // // 寻找模型存放的位置并开始渲染
        // // vtpReader.setUrl("../static/combine/TCGA_CS_5397.vtp").then(beginRender);
        //
        // function animateRotation(axis, angle) {
        //     const center = getCenterOfMass();
        //     actor.setOrigin(...center);
        //
        //     const increment = 5;
        //     let currentAngle = 0;
        //     const animation = () => {
        //         if (currentAngle < angle) {
        //             currentAngle += increment;
        //             actor.rotateWXYZ(increment, ...axis);
        //             renderWindow.render();
        //             requestAnimationFrame(animation);
        //         }
        //     };
        //     animation();
        // }
        //  // 控制按钮
        // document.getElementById('rotateLeft').addEventListener('click', function () {
        //     animateRotation([0, 0, -1], 90);
        // });
        //
        // document.getElementById('rotateRight').addEventListener('click', function () {
        //     animateRotation([0, 0, 1], 90);
        // });
        //
        // document.getElementById('rotateUp').addEventListener('click', function () {
        //     animateRotation([1, 0, 0], 90);
        // });
        //
        // document.getElementById('rotateDown').addEventListener('click', function () {
        //     animateRotation([-1, 0, 0], 90);
        // });
        // // 重置按钮的点击事件
        // document.getElementById('resetButton').addEventListener('click', resetCameraToInitialState);
        // 查找之前定义的用于可视化的div
        var myContainer3D = document.querySelector('#tumor_3D');
        var myContainer4D = document.querySelector('#tumor_4D');

        // 用于页面可视化的Renderer，官方文档介绍是使用fullScreenRenderer
        var fullScreenRenderer3D = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
            background: [0.0, 0.0, 0.0],
            container: myContainer3D,  // 绑定myContainer3D
        });

        var fullScreenRenderer4D = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
            background: [0.0, 0.0, 0.0],
            container: myContainer4D,  // 绑定myContainer4D
        });

        // 获取渲染器和渲染窗口
        var renderer3D = fullScreenRenderer3D.getRenderer();
        var renderWindow3D = fullScreenRenderer3D.getRenderWindow();

        var renderer4D = fullScreenRenderer4D.getRenderer();
        var renderWindow4D = fullScreenRenderer4D.getRenderWindow();

        // 定义actor和mapper
        var actor3D = vtk.Rendering.Core.vtkActor.newInstance();
        var mapper3D = vtk.Rendering.Core.vtkMapper.newInstance();

        var actor4D = vtk.Rendering.Core.vtkActor.newInstance();
        var mapper4D = vtk.Rendering.Core.vtkMapper.newInstance();

        // 定义vtpReader，读取.vtp文件
        const vtpReader3D = vtk.IO.XML.vtkXMLPolyDataReader.newInstance();
        const vtpReader4D = vtk.IO.XML.vtkXMLPolyDataReader.newInstance();

        // 进行inputConnection连接
        mapper3D.setInputConnection(vtpReader3D.getOutputPort());
        actor3D.setMapper(mapper3D);

        mapper4D.setInputConnection(vtpReader4D.getOutputPort());
        actor4D.setMapper(mapper4D);

        // 调整模型的颜色
        mapper3D.setScalarVisibility(true);
        // mapper4D.setScalarVisibility(true);
        mapper4D.setScalarVisibility(false);
        actor4D.getProperty().setColor(0, 1, 0);

        // 获取模型的中心点
        function getCenterOfMass(actor) {
            const bounds = actor.getBounds();
            const center = [
                (bounds[0] + bounds[1]) / 2,
                (bounds[2] + bounds[3]) / 2,
                (bounds[4] + bounds[5]) / 2,
            ];
            return center;
        }

        // 保存初始相机状态
        let initialCameraState3D = {};
        let initialCameraState4D = {};

        function saveInitialCameraState(renderer, initialCameraState) {
            const camera = renderer.getActiveCamera();
            initialCameraState.position = [...camera.getPosition()];
            initialCameraState.focalPoint = [...camera.getFocalPoint()];
            initialCameraState.viewUp = [...camera.getViewUp()];
            initialCameraState.clippingRange = [...camera.getClippingRange()];
        }

        function resetCameraToInitialState(renderer, renderWindow, initialCameraState) {
            const camera = renderer.getActiveCamera();
            camera.setPosition(...initialCameraState.position);
            camera.setFocalPoint(...initialCameraState.focalPoint);
            camera.setViewUp(...initialCameraState.viewUp);
            camera.setClippingRange(...initialCameraState.clippingRange);
            renderWindow.render();
        }

        // 设置渲染函数
        function beginRender(renderer, renderWindow, actor, initialCameraState) {
            renderer.addActor(actor);
            renderer.resetCamera();
            saveInitialCameraState(renderer, initialCameraState);  // 保存初始相机状态
            renderWindow.render();
        }

        // 获取患者的Patient值
        var patientNumber = "{{ patient.Patient }}";
        const tumorimage_1 = document.getElementById('tumor_three_1');
        tumorimage_1.setAttribute('src', '../static/heat_com/' + patientNumber + '/axial_com.png');
        tumorimage_1.style.cursor = 'pointer';
        const tumorimage_2 = document.getElementById('tumor_three_2');
        tumorimage_2.setAttribute('src', '../static/heat_com/' + patientNumber + '/coronal_com.png');
        tumorimage_2.style.cursor = 'pointer';
        const tumorimage_3 = document.getElementById('tumor_three_3');
        tumorimage_3.setAttribute('src', '../static/heat_com/' + patientNumber + '/sagittal_com.png');
        tumorimage_3.style.cursor = 'pointer';
        tumorimage_1.addEventListener('click', function () {
                    document.getElementById('modalImage').src = tumorimage_1.src;
                    document.getElementById('myModal').style.display = "block";
        });
        tumorimage_2.addEventListener('click', function () {
                    document.getElementById('modalImage').src = tumorimage_2.src;
                    document.getElementById('myModal').style.display = "block";
        });
        tumorimage_3.addEventListener('click', function () {
                    document.getElementById('modalImage').src = tumorimage_3.src;
                    document.getElementById('myModal').style.display = "block";
        });

        // 动态设置vtp文件的路径
        var vtpUrl3D = "../static/combine/" + patientNumber + ".vtp";
        var vtpUrl4D = "../static/combine_tumor/" + patientNumber + "_tumor.vtp";  // 设置新路径的 VTP 文件
        // 寻找模型存放的位置并开始渲染
        // vtpReader3D.setUrl(vtpUrl3D).then(() => beginRender(renderer3D, renderWindow3D, actor3D, initialCameraState3D));
        // vtpReader4D.setUrl(vtpUrl4D).then(() => beginRender(renderer4D, renderWindow4D, actor4D, initialCameraState4D));
        vtpReader4D.setUrl(vtpUrl4D).then(() => beginRender(renderer4D, renderWindow4D, actor4D, initialCameraState4D));
        vtpReader3D.setUrl(vtpUrl3D).then(() => beginRender(renderer3D, renderWindow3D, actor3D, initialCameraState3D));

        function animateRotation(actor, axis, angle, renderWindow) {
            const center = getCenterOfMass(actor);
            actor.setOrigin(...center);

            const increment = 5;
            let currentAngle = 0;
            const animation = () => {
                if (currentAngle < angle) {
                    currentAngle += increment;
                    actor.rotateWXYZ(increment, ...axis);
                    renderWindow.render();
                    requestAnimationFrame(animation);
                }
            };
            animation();
        }

        // 控制按钮
        document.getElementById('rotateLeft').addEventListener('click', function () {
            animateRotation(actor3D, [0, 0, -1], 90, renderWindow3D);
            animateRotation(actor4D, [0, 0, -1], 90, renderWindow4D);
        });

        document.getElementById('rotateRight').addEventListener('click', function () {
            animateRotation(actor3D, [0, 0, 1], 90, renderWindow3D);
            animateRotation(actor4D, [0, 0, 1], 90, renderWindow4D);
        });

        document.getElementById('rotateUp').addEventListener('click', function () {
            animateRotation(actor3D, [1, 0, 0], 90, renderWindow3D);
            animateRotation(actor4D, [1, 0, 0], 90, renderWindow4D);
        });

        document.getElementById('rotateDown').addEventListener('click', function () {
            animateRotation(actor3D, [-1, 0, 0], 90, renderWindow3D);
            animateRotation(actor4D, [-1, 0, 0], 90, renderWindow4D);
        });

        document.getElementById('resetButton').addEventListener('click', function () {
            resetCameraToInitialState(renderer3D, renderWindow3D, initialCameraState3D);
        });

        // 同步相机变换
        function syncCameras(sourceCamera, targetCamera) {
            targetCamera.setPosition(...sourceCamera.getPosition());
            targetCamera.setFocalPoint(...sourceCamera.getFocalPoint());
            targetCamera.setViewUp(...sourceCamera.getViewUp());
            targetCamera.setClippingRange(...sourceCamera.getClippingRange());
        }

        // 监听相机事件并同步相机
        const camera3D = renderer3D.getActiveCamera();
        const camera4D = renderer4D.getActiveCamera();

        camera3D.onModified(() => {
            syncCameras(camera3D, camera4D);
            renderWindow4D.render();
        });

        camera4D.onModified(() => {
            syncCameras(camera4D, camera3D);
            renderWindow3D.render();
        });

        // 同步初始状态
        syncCameras(camera3D, camera4D);
        renderWindow4D.render();
        // 图片切换功能
        const imageContainer1 = document.getElementById('imageContainer1');
        const imageContainer2 = document.getElementById('imageContainer2');
        const numImages = "{{num_images}}";
        let currentIndex = 0;
        const imagesPerGroup = 6;

        // function createImageElements(container, pathPrefix) {
        //     for (let i = 1; i <= numImages; i++) {
        //         const img = document.createElement('img');
        //         img.id = 'image' + i;
        //         img.src = `${pathPrefix}/image_${i}.png`;
        //         img.style.display = i < imagesPerGroup ? 'block' : 'none';
        //         img.addEventListener('click', function () {
        //             document.getElementById('modalImage').src = img.src;
        //             document.getElementById('myModal').style.display = "block";
        //         });
        //         container.appendChild(img);
        //     }
        // }

        function createImageElements(container, pathPrefix) {
            for (let i = numImages; i >= 1; i--) {
                const img = document.createElement('img');
                img.id = 'image' + i;
                img.src = `${pathPrefix}/image_${i}.png`;
                img.style.display = i > numImages - imagesPerGroup ? 'block' : 'none';
                img.addEventListener('click', function () {
                    document.getElementById('modalImage').src = img.src;
                    document.getElementById('myModal').style.display = "block";
                });
                container.appendChild(img);
            }
        }

        createImageElements(imageContainer1, `../static/brain_origin/${patientNumber}`);
        createImageElements(imageContainer2, `../static/brain_highlight/${patientNumber}`);

        function updateButtons() {
            document.getElementById('prevButton').disabled = currentIndex === 0;
            document.getElementById('nextButton').disabled = currentIndex + imagesPerGroup >= numImages;
        }

        function updateImageContainers() {
            const images1 = document.querySelectorAll('#imageContainer1 img');
            const images2 = document.querySelectorAll('#imageContainer2 img');
            images1.forEach((img, index) => {
                img.style.display = (index >= currentIndex && index < currentIndex + imagesPerGroup) ? 'block' : 'none';
            });
            images2.forEach((img, index) => {
                img.style.display = (index >= currentIndex && index < currentIndex + imagesPerGroup) ? 'block' : 'none';
            });
            updateButtons();
        }

        document.getElementById('prevButton').addEventListener('click', function () {
            if (currentIndex > 0) {
                currentIndex--;
                updateImageContainers();
            }
        });

        document.getElementById('nextButton').addEventListener('click', function () {
            if (currentIndex + imagesPerGroup < numImages) {
                currentIndex++;
                updateImageContainers();
            }
        });

        updateImageContainers();
        const img = document.getElementById('mriSlides');
        img.src = `../static/slides_50/${patientNumber}/axial/axial_slice_${numImages-1}.png`
        const axial = document.getElementById('axial');
        axial.setAttribute('data-max',`${numImages-1}`)
        const slider = document.getElementById('frameSlider');
        slider.max=`${numImages-1}`

        document.addEventListener('DOMContentLoaded', () => {
            const img = document.getElementById('mriSlides');
            const slider = document.getElementById('frameSlider');
            const selector = document.getElementById('selectSlides');

            const updateImage = () => {
                const currentFrame = slider.value;
                const select = selector.value;
                if (select === 'axial') {
                    img.src = `../static/slides_50/${patientNumber}/${select}/${select}_slice_${selector.options[selector.selectedIndex].dataset.max - currentFrame}.png`;
                } else {
                    img.src = `../static/slides_50/${patientNumber}/${select}/${select}_slice_${currentFrame}.png`
                }
            };

            const updateSlider = () => {
                const maxFrame = selector.options[selector.selectedIndex].dataset.max;
                slider.max = maxFrame;
                slider.value = 0; // Reset slider value
                updateImage(); // Update image based on new selection
            };

            slider.addEventListener('input', updateImage);
            selector.addEventListener('change', updateSlider);
        });
        // Get the modal
        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];
        span.onclick = function () {
            modal.style.display = "none";
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
